<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cycle Checker</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <h1>Cycle Checker</h1>
    <p>Please input date</p>
    <input type="date" id="input" onchange="document.getElementById('results').innerHTML = out_format(get_calendar_next_day(new Date(this.value)));">
    <div id="results"></div>
    <p class="description_text">The information is for reference only</p>
    <script>
      let calendar_data;
      fetch("data/cd.json")
        .then(response => response.json())
        .then(data => {
          calendar_data = data;
        });
      function format_date(d) {
        return d.toLocaleDateString("en-GB");
      }
      function get_calendar_next_day(in_day) {
        const formatted_calendar_data = new Set(Object.keys(calendar_data));
        const start_day = new Date("2025-11-07");
        let next_day = new Date(in_day);
        let days_between = [];
        for (let i = 0; i < 365; i++) {
          next_day.setDate(next_day.getDate() + 1);
          const weekday = next_day.getDay();
          const string = format_date(next_day);
          if (weekday !== 0 && weekday !== 6 && !formatted_calendar_data.has(string)) {
            break;
          }
        }
        let cycle_no = 0;
        let count_day = new Date(start_day);
        while (count_day < next_day) {
          const weekday = count_day.getDay();
          const string = format_date(count_day);
          if (weekday !== 0 && weekday !== 6 && !formatted_calendar_data.has(string)) {
            cycle_no++;
          }
          if (formatted_calendar_data.has(string) && count_day > in_day) {
            days_between.push([new Date(count_day), calendar_data[string][0]]);
          }
          count_day.setDate(count_day.getDate() + 1);
        }
        return [format_date(next_day), cycle_no % 6 + 1, days_between, cycle_no];
      }
      function out_format(data) {
        if (!Array.isArray(data) || data.length !== 4) {
          return "No calendar data available.";
        }
        const [next_day, cycle_day, holidays] = data;
        let output = "";
        if (Array.isArray(holidays) && holidays.length > 0) {
          for (const [date, name] of holidays) {
            const string = new Date(date).toLocaleDateString("en-GB");
            output += `${string} ${name}<br>`;
          }
        }
        output += `${next_day} Next Scheduled Day (Day ${cycle_day})`;
        return output;
      }
    </script>
  </body>
</html>
